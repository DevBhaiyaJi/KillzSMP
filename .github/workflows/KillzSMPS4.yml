name: Minecraft Server (Google Drive + Backup, Java 21, 7GB RAM)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */5 * * *"   # har 5 ghante restart

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 3600

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3

    - name: Setup Java 21
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '21'

    - name: Install tools
      run: sudo apt-get install -y unzip zip curl screen

    - name: Setup rclone from base64 secret
      run: |
        mkdir -p ~/.config/rclone
        echo "${{ secrets.RCLONE_CONF_B64 }}" | base64 --decode > ~/.config/rclone/rclone.conf
        curl https://rclone.org/install.sh | sudo bash
        rclone version

    - name: Download server.jar
      run: |
        mkdir -p server
        rclone copy gdrive:/mc/server.jar server/

    - name: Download and extract world
      run: |
        if rclone ls gdrive:/mc/world.zip; then
          rclone copy gdrive:/mc/world.zip server/ --drive-acknowledge-abuse
          unzip -o server/world.zip -d server/
        else
          mkdir -p server/world
        fi

    - name: Download and extract plugins
      run: |
        mkdir -p server/plugins
        if rclone ls gdrive:/mc/plugins.zip; then
          rclone copy gdrive:/mc/plugins.zip server/ --drive-acknowledge-abuse
          unzip -o server/plugins.zip -d server/plugins
        fi

    - name: Accept EULA
      run: echo "eula=true" > server/eula.txt

    - name: Set server.properties
      run: echo "online-mode=false" >> server/server.properties

    - name: Add server operator
      run: |
        echo '[{"uuid":"00000000-0000-0000-0000-000000000000","name":"NotDev42","level":4,"bypassesPlayerLimit":false}]' > server/ops.json

    - name: Start Minecraft server
      run: |
        cd server
        screen -dmS mc java -Xmx7G -Xms2G -jar server.jar nogui
        sleep 60  # safe start for large worlds

    - name: Install Playit
      run: |
        curl -L https://github.com/playit-cloud/playit-agent/releases/latest/download/playit-linux-amd64 -o playit
        chmod +x playit
        ./playit --secret ${{ secrets.PLAYIT_SECRET }} &

    - name: Keep server alive
      run: sleep 18000   # ~5 ghante

    - name: Stop server safely and backup
      if: always()
      run: |
        cd server
        # Safe stop server
        screen -S mc -p 0 -X stuff "save-all\nstop\n"
        sleep 20
        # Zip world and plugins (overwrite old)
        zip -r world.zip world
        zip -r plugins.zip plugins
        rclone copy -f world.zip gdrive:/mc/ --drive-acknowledge-abuse
        rclone copy -f plugins.zip gdrive:/mc/ --drive-acknowledge-abuse

    - name: Check Playit account
      run: |
        ./playit --secret ${{ secrets.PLAYIT_SECRET }} status
